# Tryhackme 8 August 2021
## Attacking Kerberos

>What does TGT stand for?

Ticket granting ticket
>What does SPN stand for?

Service principal name

>What does PAC stand for?

Privilege attribute certificate

>AS-REQ w/ Pre-Authentication In Detail

AS: Authentication service; to issue TGTs

1. AS-REQ begins in Kerberos authentication when a TGT is requested by user to the KDC.
1. To validate and provide TGT to user, KDC must follow specific steps
1. User encrypts a timestamp NT hash.
1. Hash sent to the AS
1. KDC decrypts the timestamp using the NT hash received from user.
1. If successful, TGT granted and a session key for the user.

>Ticket Granting Ticket Contents

![tryhackme tgt](https://i.imgur.com/QFeXDN0.png)

From Tryhackme Attacking Kerberos room

1. TGT is provided by the user to the KDC. (Remember, a user first has to obtain a TGT from KDC)
1. KDC validates the TGT and returns a service ticket (TGS)

>Service Ticket Contents 

Contains two portions:
1. Service portion: user details, session key, encrypts tickets with service account NTLM hash
1. User-portion: validity timestamp, session key, encrypts with TGT session key

>What two services make up the KDC?

AS, TGS

>Kerberos Authentication Diagram

![kerberos diagram](https://i.imgur.com/VRr2B6w.png)

1. AS-REQ: user requests for TGT
1. AS-REQ: KDC verifies client and sends back an *encrypted* TGT
1. TGS-REQ: The encrypted TGT is sent to TGS *with* the Service Principal Name (SPN) of the service the client wants to access
1. TGS-REQ: KDC verifies TGT of the user and also if the user has access to the service. A valid session key for the service is then sent.
1. AP-REQ: Client requests for the service and sends the session key to prove it has access to it.
1. AP-REQ: Server performs authentication and access granted.

>Kerberos Ticket Overview

1. The TGT will usually be in a .kirbi format for Rubeus or .ccache for Impacket. The tickets are usually encoded in base64 (which probably explained why the file containing a domain name and passwword was encoded in base64(?)).
1. TGT is only used with KDC to get service tickets (TGS)
1. Once a TGT is provided, the server should reply with User details, Session key, and encrypts the service ticket with the service account NTLM hash.
1. TGT provides the encrypted timestamp, session key, and the encrypted TGT.
1. KDC authenticates the TGT and provides the service ticket based on the service requested.
1. Typically, the provided TGT would only work with the assosciated service.
1. A KRBTGT instead can allow attacker to gain any service access which allows any access to anything in the domain.

## Tryhackme  9 August 2021
### Enumerating Kerberos

As I already have Kerbrute installed from a previous room attempt, I am not gonna bother detailing how to install it. However, I will note that the IP address of the machine need to be added into the /etc/hosts file or Kerbrute will not work. Not sure how I managed to finished the previous room while not remembering about this tidbit. Maybe I used the IP address instead of a variable? Will need to revisit that at some point.

>How many total users do we enumerate?

10

>What is the SQL service account name?

sqlservice

>What is the second "machine" account name?

machine2

>What is the third "user" account name?

user3

### Harvesting & Brute-Forcing Tickets w/ Rubeus 

This section requires the use of a tool called Rubeus. The tool seems to be very powerful to attack Active Directories with the slew of features it has.

As a first impression, to use this, it seems Rubeus must be installed on the target machine because it is pre-installed with the target machine that I ssh'd into.

#### Harvesting Tickets w/ Rubeus 

'Harvesting' is a process that gathers the tickets that are being transferred to the KDC and saves them. Afterwards, it can  be used for attacks like pass the ticket apparently.

>Rubeus.exe harvest /interval:30

A command to harvest tickets every 30 seconds.

### Brute-Forcing / Password-Spraying w/ Rubeus 

Brute-forcing should be familiar to most people and myself but Password Spraying is a new concept for me so I will be describing it in a way I can understand.

>Password spraying

Simply means take 1 password and try it against all known usernames to see which ones use that password.

Before password spraying wiwth Rubeus, the CONTROLLER.local (could be anything I'm pretty sure, treating it as a variable name) must be set to the machine IP address.

>echo 10.10.147.2 CONTROLLER.local >> C:\Windows\System32\drivers\etc\hosts

This command is executed. Should be self explanatory.

>Rubeus.exe brute /password:Password1 /noticket

Afterwards, this command is executed. The password is provided and sprayed against all found users. Afterwards, a .kirbi TGT is given for the found user.

![rubeus](assets/img/rubeus.png)

### Kerberoasting w/ Rubeus & Impacket

#### A refresher on Kerberoasting

On a previous room, I learned the gist of Kerberoasting from other walkthroughs. This room does describe Kerberoasting in more detail. 

1. Generally, Kerberoasting allows a user to request a service ticket for any service *WITH* a registered SPN.
1. The ticket is then used to crack the service password.
1. For a service to be Kerberoastable, it needs to have a registered SPN.
1. Success depends on password strength and if it is trackable (not sure what that means, speculation: whether the account can be discovered in the enumeration stage, maybe. Will edit this out when I find out.)
1. The success also depends on the privilege of the cracked account.
1. A tool like Bloodhound can be used to find Kerberoastable account.